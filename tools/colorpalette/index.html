<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fashion Palette — Personalized Men's Color Guide</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
  /* -------------------------
     Theme & global styles
     ------------------------- */
  :root{
    --bg1:#0F2027;
    --bg2:#203A43;
    --bg3:#2C5364;
    --card:#111316;
    --muted:#9da4ab;
    --accent:#28a745;
    --navA:#0b2a4a;
    --navB:#0a517a;
    --glass: rgba(255,255,255,0.02);
    --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    min-height:100%;
    font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));
    color:#eceef0;
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:28px;
  }

  /* -------------------------
     Header & branding
     ------------------------- */
  header{width:100%; max-width:1200px; text-align:center; margin-bottom:10px;}
  .brand {
    display:flex;
    align-items:center;
    justify-content:center;
    gap:18px;
    margin-bottom:6px;
    flex-wrap:wrap;
  }
  .logo-large{
    width:140px;
    height:140px;
    border-radius:50%;
    object-fit:cover;
    box-shadow: 0 12px 40px rgba(0,0,0,0.5);
    border: 3px solid rgba(255,255,255,0.03);
    background: linear-gradient(180deg,#fff, #eee);
  }
  h1{font-size:30px; margin:6px 0 0 0; line-height:1; font-weight:700}
  .subtitle{color:var(--muted); margin-top:6px; font-size:14px}

  /* -------------------------
     Navigation (blue gradient like your site)
     ------------------------- */
  .main-nav{
    width:100%;
    max-width:1200px;
    margin: 18px 0;
    padding:12px 16px;
    border-radius:18px;
    background: linear-gradient(90deg,var(--navA),var(--navB));
    box-shadow: 0 12px 40px rgba(0,0,0,0.45);
    display:flex;
    justify-content:center;
    gap:12px;
  }
  .main-nav a{
    color:#eaf4ff;
    text-decoration:none;
    padding:10px 16px;
    border-radius:10px;
    font-weight:600;
    transition: transform .14s, background .12s;
  }
  .main-nav a:hover{ transform: translateY(-3px); background: rgba(255,255,255,0.04); }
  .main-nav a.active{ background: rgba(255,255,255,0.06); box-shadow: inset 0 -2px 6px rgba(0,0,0,0.12); }

  /* -------------------------
     Page container & cards
     ------------------------- */
  main{
    width:100%;
    max-width:1200px;
  }
  .card{
    background: linear-gradient(180deg,var(--card), #0c0d0f);
    padding:20px;
    border-radius:var(--radius);
    box-shadow: 0 20px 60px rgba(0,0,0,0.6);
    margin-bottom:20px;
  }

  /* -------------------------
     Subscribe embed (centered)
     ------------------------- */
  .embed-wrap{
    display:flex;
    align-items:center;
    justify-content:center;
    min-height:420px;
    padding:12px;
  }
  .beehiiv-embed{
    width:100%;
    max-width:820px;
    height:420px;
    border-radius:8px;
    border:0;
    display:block;
    background:transparent;
  }

  /* -------------------------
     Upload area
     ------------------------- */
  .upload-area{
    border-radius:12px;
    padding:26px;
    background:var(--glass);
    border:1px dashed rgba(255,255,255,0.04);
    text-align:center;
    cursor:pointer;
    transition: transform .16s, box-shadow .16s;
  }
  .upload-area:hover{ transform: translateY(-6px); box-shadow: 0 18px 48px rgba(0,0,0,0.6); }
  .upload-title{ font-weight:700; font-size:18px; }
  .upload-instructions{ color:var(--muted); margin-top:8px; font-size:13px; }

  input[type=file]{ display:none; }
  #previewImage{ display:block; max-width:420px; border-radius:12px; margin-top:14px; box-shadow:0 12px 36px rgba(0,0,0,0.5); }

  /* -------------------------
     Palette grid & swatches
     ------------------------- */
  .palette-header{ display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
  .palette-grid{
    display:grid;
    grid-template-columns: repeat(3,1fr);
    gap:16px;
    margin-top:16px;
  }
  .swatch-card{
    display:flex;
    gap:14px;
    padding:14px;
    border-radius:12px;
    background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
    align-items:flex-start;
    transition: transform .16s, box-shadow .16s;
  }
  .swatch-card:hover{ transform: translateY(-6px); box-shadow: 0 14px 36px rgba(0,0,0,0.45); }
  .swatch-sample{ width:120px; height:86px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); flex-shrink:0; box-shadow: inset 0 -20px 36px rgba(0,0,0,0.08) }
  .swatch-meta{ flex:1 }
  .color-name{ font-weight:700; font-size:16px; color:#f6f7f8; }
  .color-role{ color:var(--muted); font-size:13px; margin-top:6px; }
  .color-reason{ margin-top:8px; color:#e6e6e6; font-size:14px; line-height:1.35; }

  /* -------------------------
     Advice blocks
     ------------------------- */
  .advice-grid{
    display:grid;
    grid-template-columns: repeat(3,1fr);
    gap:12px;
    margin-top:18px;
  }
  .advice-card{
    background: linear-gradient(180deg, #0b0c0d, #0f1112);
    padding:14px;
    border-radius:10px;
    min-height:100px;
  }

  .section-title{ font-weight:800; margin-bottom:8px; font-size:15px; color:#f6f7f8; }
  .muted{ color:var(--muted); }

  /* -------------------------
     Responsive
     ------------------------- */
  @media (max-width:1100px){
    .palette-grid{ grid-template-columns: repeat(2,1fr); }
  }
  @media (max-width:720px){
    .brand { flex-direction:column; gap:10px; }
    .logo-large{ width:110px; height:110px; }
    .palette-grid{ grid-template-columns: 1fr; }
    .advice-grid{ grid-template-columns: 1fr; }
    .beehiiv-embed{ height:360px; max-width:100% }
  }
</style>
</head>
<body>
<header>
  <div class="brand">
    <!-- large central logo (replace src with your real asset if desired) -->
    <img class="logo-large" src="https://yt3.ggpht.com/6s8JL9X0gjAA2Toh9htfTY_HnaRtDTvd6cuV5U_vuAT15WTnsa07J8CHrvG6cgHkeaD25qemDA=s600-c-k-c0x00ffffff-no-rj-rp-mo" alt="Brand logo">
    <div>
      <h1>Fashion Palette — Outfit Colors That Suit You</h1>
      <div class="subtitle">Upload a clear photo — we analyze skin, eyes & hair locally and return outfit-focused, masculine palette suggestions with detailed rationale.</div>
    </div>
  </div>
</header>

<nav class="main-nav" role="navigation" aria-label="Main navigation">
  <a href="/" class="active">Home</a>
  <a href="/tools/">Tools</a>
  <a href="https://store.ascentimprovement.com/" target="_blank" rel="noopener">Store</a>
</nav>

<main>
  <!-- SUBSCRIBE (shows when not subscribed) -->
  <section class="card" id="subscribeCard" style="display:none" aria-hidden="false">
    <div class="embed-wrap">
      <!-- user-provided Beehiiv embed -->
      <script async src="https://subscribe-forms.beehiiv.com/embed.js"></script>
      <iframe src="https://subscribe-forms.beehiiv.com/2ec63069-4b7e-45b2-be4b-18e8c4d306d9"
              class="beehiiv-embed"
              data-test-id="beehiiv-embed"
              frameborder="0"
              scrolling="no"
              style="width: 767px; height: 420px; margin: 0; border-radius: 0px 0px 0px 0px !important; background-color: transparent; box-shadow: 0 0 #0000; max-width: 100%;"></iframe>
      <script type="text/javascript" async src="https://subscribe-forms.beehiiv.com/attribution.js"></script>
    </div>
  </section>

  <!-- UPLOAD (shows when subscribed) -->
  <section class="card" id="uploadCard" style="display:none">
    <div id="uploadArea" class="upload-area" tabindex="0" role="button" aria-label="Upload a photo">
      <div class="upload-title">Upload a clear photo of your face</div>
      <div class="upload-instructions muted">Natural daylight works best. We run the analysis locally in your browser — nothing is uploaded to our servers.</div>
      <input id="fileInput" type="file" accept="image/*" aria-label="Choose an image">
      <img id="previewImage" src="" alt="Preview" style="display:none">
      <div class="controls" style="margin-top:12px;">
        <button id="analyzeBtn" class="btn" style="display:none">Analyze Now</button>
      </div>
    </div>
  </section>

  <!-- RESULTS -->
  <section class="card" id="resultsCard" style="display:none">
    <div class="palette-header">
      <div>
        <div class="section-title">Your Personalized Fashion Palette</div>
        <div class="muted">We present a larger, masculine palette with recommendations for clothing, seasons and jewelry — plus why each color works with your features.</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button id="downloadBtn" class="btn">Download Palette</button>
        <button id="uploadAnotherBtn" class="btn secondary">Upload Another</button>
      </div>
    </div>

    <div id="paletteGrid" class="palette-grid" aria-live="polite"></div>

    <div class="advice-grid">
      <div class="advice-card">
        <div class="section-title">Outfit Recommendations</div>
        <div id="outfitText" class="muted"></div>
      </div>
      <div class="advice-card">
        <div class="section-title">Season Guidance</div>
        <div id="seasonText" class="muted"></div>
      </div>
      <div class="advice-card">
        <div class="section-title">Jewelry & Accessories</div>
        <div id="jewelryText" class="muted"></div>
      </div>
    </div>
  </section>
</main>

<footer>Private & client-side — no photos are uploaded. Built for men's wardrobe clarity.</footer>

<script>
/* ============================================================
   Full JS: gating (emailSubmitted), client-side analysis,
   mapping to 14–16 masculine colors, improved advice generation.
   Key: uses localStorage key "emailSubmitted" (as you requested).
   ============================================================ */

const subscribeCard = document.getElementById('subscribeCard');
const uploadCard = document.getElementById('uploadCard');
const resultsCard = document.getElementById('resultsCard');

const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const previewImage = document.getElementById('previewImage');
const analyzeBtn = document.getElementById('analyzeBtn');

const paletteGrid = document.getElementById('paletteGrid');
const outfitText = document.getElementById('outfitText');
const seasonText = document.getElementById('seasonText');
const jewelryText = document.getElementById('jewelryText');

const downloadBtn = document.getElementById('downloadBtn');
const uploadAnotherBtn = document.getElementById('uploadAnotherBtn');

let lastAnalysis = null;
let lastSeenFlag = localStorage.getItem('emailSubmitted') || 'false';

/* -------------------------
   Large fashion palette bank (14 colors)
   - all masculine-focused
   ------------------------- */
const FASHION_COLORS = [
  { name: 'Navy', hex: '#0B3D91' },
  { name: 'Charcoal', hex: '#2F3542' },
  { name: 'Black', hex: '#0F1112' },
  { name: 'White', hex: '#F7F7F7' },
  { name: 'Dark Brown', hex: '#5A381E' },
  { name: 'Camel', hex: '#C29B6D' },
  { name: 'Olive', hex: '#6B8E23' },
  { name: 'Khaki', hex: '#BDB48F' },
  { name: 'Denim Blue', hex: '#2C6EB2' },
  { name: 'Stone Gray', hex: '#9EA3A8' },
  { name: 'Burgundy', hex: '#6B1E2C' },
  { name: 'Forest Green', hex: '#1F5D3B' },
  { name: 'Taupe', hex: '#8D8575' },
  { name: 'Steel Blue', hex: '#3A6B9A' },
  { name: 'Rust', hex: '#A54A24' },
  { name: 'Deep Teal', hex: '#0E5F5D' }
];

/* -------------------------
   Gating helpers (emailSubmitted key)
   ------------------------- */
function isSubscribed(){
  return localStorage.getItem('emailSubmitted') === 'true';
}

function updateUIForSubscription(){
  if (isSubscribed()){
    subscribeCard.style.display = 'none';
    uploadCard.style.display = 'block';
  } else {
    subscribeCard.style.display = 'block';
    uploadCard.style.display = 'none';
    resultsCard.style.display = 'none';
  }
}

/* If user visits the confirmation route, set the flag */
if (window.location.pathname === '/subscribe-confirmation') {
  try { localStorage.setItem('emailSubmitted', 'true'); } catch(e){}
}

/* Init UI */
updateUIForSubscription();

/* Listen for cross-tab changes */
window.addEventListener('storage', (e) => {
  if (e.key === 'emailSubmitted') {
    updateUIForSubscription();
    if (isSubscribed() && lastAnalysis) {
      renderResults(lastAnalysis);
    }
  }
});

/* Poll fallback in case embed doesn't fire storage or redirect */
setInterval(() => {
  const now = localStorage.getItem('emailSubmitted') || 'false';
  if (now !== lastSeenFlag) {
    lastSeenFlag = now;
    updateUIForSubscription();
    if (isSubscribed() && lastAnalysis) renderResults(lastAnalysis);
  }
}, 800);

/* -------------------------
   Upload interactions
   ------------------------- */
uploadArea.addEventListener('click', () => {
  if (!isSubscribed()) { subscribeCard.scrollIntoView({behavior:'smooth', block:'center'}); return; }
  fileInput.click();
});
uploadArea.addEventListener('keydown', (e) => {
  if ((e.key === 'Enter' || e.key === ' ') && isSubscribed()) { fileInput.click(); e.preventDefault(); }
});

/* Drag & drop */
uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.style.boxShadow = '0 18px 48px rgba(0,0,0,0.5)'; });
uploadArea.addEventListener('dragleave', (e) => { e.preventDefault(); uploadArea.style.boxShadow = ''; });
uploadArea.addEventListener('drop', (e) => {
  e.preventDefault();
  uploadArea.style.boxShadow = '';
  if (!isSubscribed()) { subscribeCard.scrollIntoView({behavior:'smooth', block:'center'}); return; }
  const f = e.dataTransfer.files && e.dataTransfer.files[0];
  if (f) handleFile(f);
});

/* File input */
fileInput.addEventListener('change', (e) => {
  const f = e.target.files && e.target.files[0];
  if (f) handleFile(f);
});

function handleFile(file) {
  if (!file.type.startsWith('image/')) { alert('Please upload an image file (jpg, png).'); return; }
  const reader = new FileReader();
  reader.onload = (ev) => {
    previewImage.src = ev.target.result;
    previewImage.style.display = 'block';
    analyzeImageAndMaybeRender(ev.target.result);
  };
  reader.readAsDataURL(file);
}

/* -------------------------
   Image analysis
   ------------------------- */
function analyzeImageAndMaybeRender(dataUrl){
  clientSideImageAnalysis(dataUrl).then(analysis => {
    lastAnalysis = analysis;
    if (isSubscribed()) {
      renderResults(analysis);
    } else {
      // keep cached; prompt subscribe
      updateUIForSubscription();
      subscribeCard.scrollIntoView({behavior:'smooth', block:'center'});
    }
  }).catch(err => {
    console.error('analysis failed', err);
    alert('Image analysis failed — try a different photo or better lighting.');
  });
}

function clientSideImageAnalysis(dataUrl){
  return new Promise((resolve,reject) => {
    const img = new Image();
    img.crossOrigin = 'Anonymous';
    img.onload = () => {
      // downscale to speed up sampling (keep aspect)
      const maxDim = 600;
      let w = img.width, h = img.height;
      if (Math.max(w,h) > maxDim){
        if (w > h){ h = Math.round(h * maxDim / w); w = maxDim; } else { w = Math.round(w * maxDim / h); h = maxDim; }
      }
      const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);

      // heuristic sampling boxes
      const skinBox = { x: Math.round(w*0.25), y: Math.round(h*0.36), width: Math.round(w*0.5), height: Math.round(h*0.28) };
      const hairBox = { x: 0, y: 0, width: w, height: Math.round(h*0.18) };
      const eyeBox = { x: Math.round(w*0.28), y: Math.round(h*0.26), width: Math.round(w*0.44), height: Math.round(h*0.12) };

      const skinAvg = sampleRegionAvg(ctx, skinBox);
      const hairAvg = sampleRegionAvg(ctx, hairBox);
      const eyeAvg = sampleRegionAvg(ctx, eyeBox);

      const skinUndertone = estimateUndertone(skinAvg);
      const eyeTone = classifyEye(eyeAvg);
      const hairShade = classifyHairShade(hairAvg);

      const mapped = mapToFashionPalette([skinAvg, hairAvg, eyeAvg]);

      // diversify palette: ensure staples (navy/charcoal/white) + colors that reflect analysis
      const diversified = diversifyPalette(mapped);

      const paletteWithReasons = diversified.map(c => ({
        name: c.name,
        hex: c.hex,
        reason: generateReasonText(c, skinUndertone, eyeTone, hairShade)
      }));

      const advice = generateAdvice(skinUndertone, paletteWithReasons.map(p=>p.name));

      resolve({ skinAvg, hairAvg, eyeAvg, skinUndertone, eyeTone, hairShade, palette: paletteWithReasons, advice });
    };
    img.onerror = (e) => reject(e);
    img.src = dataUrl;
  });
}

/* sample average color from region */
function sampleRegionAvg(ctx, box){
  const w = ctx.canvas.width, h = ctx.canvas.height;
  const x0 = Math.max(0, Math.min(w-1, box.x));
  const y0 = Math.max(0, Math.min(h-1, box.y));
  const bw = Math.max(1, Math.min(box.width, w - x0));
  const bh = Math.max(1, Math.min(box.height, h - y0));
  try {
    const data = ctx.getImageData(x0, y0, bw, bh).data;
    let r=0,g=0,b=0,count=0;
    const step = 6;
    for (let i=0;i<data.length;i+=4*step){
      const alpha = data[i+3];
      if (alpha < 100) continue;
      const rr = data[i], gg = data[i+1], bb = data[i+2];
      const bright = (rr*299 + gg*587 + bb*114)/1000;
      if (bright > 250) continue;
      r+=rr; g+=gg; b+=bb; count++;
    }
    if (count===0) return { r:180, g:160, b:140 };
    return { r: Math.round(r/count), g: Math.round(g/count), b: Math.round(b/count) };
  } catch(e){
    return { r:180, g:160, b:140 };
  }
}

/* -------------------------
   Color utils & classifiers
   ------------------------- */
function rgbToHex(r,g,b){ const toHex = n => ("0"+Math.max(0,Math.min(255,Math.round(n))).toString(16)).slice(-2); return '#'+toHex(r)+toHex(g)+toHex(b); }
function hexToRgb(hex){ const h = hex.replace('#',''); const bigint = parseInt(h,16); return { r:(bigint>>16)&255, g:(bigint>>8)&255, b:bigint&255 }; }
function colorDistanceSq(a,b){ const dr=a.r-b.r, dg=a.g-b.g, db=a.b-b.b; return dr*dr+dg*dg+db*db; }

function estimateUndertone(rgb){
  if (rgb.r - rgb.g > 12 && rgb.r - rgb.b > 10) return 'warm';
  if (rgb.b - rgb.r > 8) return 'cool';
  return 'neutral';
}
function classifyEye(rgb){
  const {r,g,b}=rgb;
  if (b > r+15 && b > g+10) return 'blue';
  if (g > r+12 && g > b+8) return 'green';
  if (r > g && r > b) return 'brown';
  return 'neutral';
}
function classifyHairShade(rgb){
  const bright = (rgb.r*299 + rgb.g*587 + rgb.b*114)/1000;
  if (bright < 60) return 'very dark';
  if (bright < 110) return 'dark';
  if (bright < 170) return 'light';
  return 'very light';
}

/* -------------------------
   Map raw samples to nearest fashion colors
   ------------------------- */
function mapToFashionPalette(sampleRgbs){
  const pool = FASHION_COLORS.map(c => ({...c, rgb: hexToRgb(c.hex)}));
  const picked = [];
  const used = new Set();

  // for each sample rgb, pick nearest color in pool not used yet
  for (let s of sampleRgbs){
    if (!s) continue;
    let best=null, bestD=Infinity;
    for (let p of pool){
      if (used.has(p.name)) continue;
      const d = colorDistanceSq(s, p.rgb);
      if (d < bestD){ best = p; bestD = d; }
    }
    if (best){ picked.push({name:best.name, hex:best.hex}); used.add(best.name); }
  }

  // ensure core neutrals present (Navy, Charcoal, White) for usability
  const core = ['Navy','Charcoal','White'];
  for (let c of core){
    if (!used.has(c)){
      const found = pool.find(x=>x.name===c);
      if (found){ picked.push({name:found.name, hex:found.hex}); used.add(found.name); }
    }
  }

  // fill to 12 with remaining diverse colors, prefer earth tones then accents
  const priority = ['Dark Brown','Camel','Olive','Khaki','Denim Blue','Stone Gray','Burgundy','Forest Green','Taupe','Steel Blue','Rust','Deep Teal'];
  for (let pName of priority){
    if (picked.length >= 12) break;
    if (!used.has(pName)){
      const f = pool.find(x=>x.name===pName);
      if (f){ picked.push({name:f.name, hex:f.hex}); used.add(f.name); }
    }
  }

  return picked.slice(0,12);
}

/* Diversify palette slightly to avoid near-duplicates:
   if many colors are close, push in some distinct staples.
*/
function diversifyPalette(palette){
  // remove near duplicates by hex distance
  const uniq = [];
  for (let p of palette){
    const rgb = hexToRgb(p.hex);
    let tooClose = false;
    for (let u of uniq){
      const ur = hexToRgb(u.hex);
      if (colorDistanceSq(rgb, ur) < 1600) { tooClose = true; break; }
    }
    if (!tooClose) uniq.push(p);
  }
  // ensure length ~12 by adding staples not present
  const pool = FASHION_COLORS;
  let idx = 0;
  while (uniq.length < 12 && idx < pool.length){
    const candidate = pool[idx++];
    if (!uniq.find(x=>x.name===candidate.name)) uniq.push({name:candidate.name, hex:candidate.hex});
  }
  return uniq.slice(0,12);
}

/* -------------------------
   Explanations & Advice
   ------------------------- */
function generateReasonText(colorObj, skinUndertone, eyeTone, hairShade){
  const name = colorObj.name.toLowerCase();
  const reasons = [];
  if (skinUndertone === 'warm'){
    if (name.includes('camel') || name.includes('dark brown') || name.includes('rust')) reasons.push('Warms up your complexion and blends with warm undertones.');
    else if (name.includes('navy') || name.includes('denim') || name.includes('steel')) reasons.push('Provides crisp contrast against warm skin for a refined look.');
  } else if (skinUndertone === 'cool'){
    if (name.includes('navy') || name.includes('charcoal') || name.includes('deep teal')) reasons.push('Matches cool undertones and gives a clean, modern impression.');
    else if (name.includes('stone') || name.includes('taupe') || name.includes('white')) reasons.push('Soft neutrals balance cool skin without washing you out.');
  } else {
    reasons.push('Neutral undertone — a flexible staple that pairs across many looks.');
  }

  if (eyeTone === 'blue' && name.includes('navy')) reasons.push('Navy helps blue eyes appear deeper and more defined.');
  if (eyeTone === 'green' && (name.includes('olive') || name.includes('camel'))) reasons.push('Olive/camel bring out green tones in the eyes.');
  if (eyeTone === 'brown' && (name.includes('burgundy') || name.includes('stone') || name.includes('rust'))) reasons.push('Earthy accents complement brown eyes for a cohesive appearance.');

  if (hairShade.includes('dark') && (name.includes('camel') || name.includes('stone') || name.includes('white'))) reasons.push('Lighter accents create elegant contrast with darker hair.');
  if (hairShade.includes('light') && (name.includes('charcoal') || name.includes('navy') || name.includes('black'))) reasons.push('Darker shades ground lighter hair and sharpen your silhouette.');

  if (reasons.length === 0) reasons.push('Versatile staple — great for jackets, trousers, or subtle accents.');

  return reasons.join(' ');
}

function generateAdvice(skinUndertone, paletteNames){
  // Jewelry
  let jewelry = 'Neutral: both silver and gold can work depending on outfit contrast.';
  if (skinUndertone === 'warm') jewelry = 'Gold and warm metals (bronze, warm leather straps) will enhance your undertone.';
  if (skinUndertone === 'cool') jewelry = 'Silver, white gold, or brushed steel finishes work best with cool undertones.';

  // Season guidance — produce concrete seasonal palettes
  const lower = paletteNames.map(n=>n.toLowerCase());
  const season = {
    spring: [],
    summer: [],
    autumn: [],
    winter: []
  };
  // Build season buckets from palette: simple heuristics
  lower.forEach(name => {
    if (name.includes('camel') || name.includes('dark brown') || name.includes('rust') || name.includes('olive')) {
      season.autumn.push(name);
    }
    if (name.includes('white') || name.includes('denim') || name.includes('khaki') || name.includes('stone')) {
      season.summer.push(name);
      season.spring.push(name);
    }
    if (name.includes('charcoal') || name.includes('navy') || name.includes('black') || name.includes('deep teal')) {
      season.winter.push(name);
    }
    if (name.includes('forest') || name.includes('olive') || name.includes('burgundy')) {
      season.spring.push(name);
      season.autumn.push(name);
    }
  });

  // Compose user-facing strings
  const seasonText = [];
  if (season.spring.length) seasonText.push('Spring — lighter neutrals & soft accents: ' + uniqueList(season.spring) + '.');
  if (season.summer.length) seasonText.push('Summer — fresh contrasts and denim: ' + uniqueList(season.summer) + '.');
  if (season.autumn.length) seasonText.push('Autumn — earth tones & layered textures: ' + uniqueList(season.autumn) + '.');
  if (season.winter.length) seasonText.push('Winter — deep neutrals & structured layering: ' + uniqueList(season.winter) + '.');

  // Outfit recommendations: produce 3 categories: casual, smart-casual, formal
  const combos = [];
  // casual: denim/khaki + olive + camel accents
  combos.push('Casual — Denim blue shirt or jeans + khaki/olive chinos; add camel or rust as an accent (boots, jacket).');
  // smart-casual: navy/charcoal + white + brown leather
  combos.push('Smart-casual — Navy or charcoal blazer + white or stone crew + dark denim; brown leather shoes/belt to finish.');
  // formal: charcoal/navy suit combos
  combos.push('Formal — Charcoal or navy suit, white shirt, minimal accessories; choose silver for cool undertones or warm leather/gold for warm undertones.');

  return { jewelry, season: seasonText.join(' '), combos };
}

function uniqueList(arr){
  const uniq = Array.from(new Set(arr));
  return uniq.map(s => capitalizeWords(s.replace('-', ' '))).join(', ');
}
function capitalizeWords(s){ return s.split(' ').map(w => w.charAt(0).toUpperCase()+w.slice(1)).join(' '); }

/* -------------------------
   Render results
   ------------------------- */
function renderResults(analysis){
  // show results
  subscribeCard.style.display = 'none';
  uploadCard.style.display = 'none';
  resultsCard.style.display = 'block';
  paletteGrid.innerHTML = '';

  analysis.palette.forEach(item => {
    const card = document.createElement('div');
    card.className = 'swatch-card';
    const sample = document.createElement('div');
    sample.className = 'swatch-sample';
    sample.style.background = item.hex;

    const meta = document.createElement('div');
    meta.className = 'swatch-meta';
    const title = document.createElement('div'); title.className = 'color-name'; title.textContent = item.name;
    const role = document.createElement('div'); role.className = 'color-role'; role.textContent = roleText(item.name);
    const reason = document.createElement('div'); reason.className = 'color-reason'; reason.textContent = item.reason;

    meta.appendChild(title);
    meta.appendChild(role);
    meta.appendChild(reason);

    card.appendChild(sample);
    card.appendChild(meta);
    paletteGrid.appendChild(card);
  });

  // advice
  const outfitHtml = analysis.advice.combos.map((c,i) => `<strong>${i===0?'Casual':i===1?'Smart-casual':'Formal'}:</strong> ${c}`).join('<br><br>');
  outfitText.innerHTML = outfitHtml;
  seasonText.textContent = analysis.advice.season;
  jewelryText.textContent = analysis.advice.jewelry;

  // store for download
  window._lastFashionPalette = analysis.palette.map(p => ({ name: p.name, hex: p.hex }));
}

/* small role text helper */
function roleText(name){
  const n = name.toLowerCase();
  if (n.includes('navy')) return 'Great for jackets, suits & outerwear.';
  if (n.includes('charcoal') || n.includes('black')) return 'Strong base for suits & trousers.';
  if (n.includes('white')) return 'Shirts & tees — creates crisp contrast.';
  if (n.includes('camel') || n.includes('dark brown') || n.includes('taupe')) return 'Accents, shoes & knitwear — adds warmth.';
  if (n.includes('olive') || n.includes('khaki') || n.includes('forest')) return 'Casual trousers & utility pieces.';
  if (n.includes('denim')) return 'Jeans & casual shirts.';
  if (n.includes('stone')) return 'Neutral knitwear & layering.';
  return 'Versatile wardrobe staple.';
}

/* -------------------------
   Download functionality
   ------------------------- */
downloadBtn.addEventListener('click', () => {
  const palette = window._lastFashionPalette;
  if (!palette || !palette.length) { alert('No palette available to download.'); return; }
  const cols = Math.min(4, palette.length);
  const rows = Math.ceil(palette.length/cols);
  const sw = 320, sh = 180, pad = 24;
  const canvas = document.createElement('canvas'); canvas.width = cols*sw + pad*2; canvas.height = rows*sh + pad*2 + 80;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#0d0d0d'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.font = '22px Inter, Arial'; ctx.fillStyle = '#fff'; ctx.textAlign = 'center';
  palette.forEach((p,i) => {
    const col = i % cols, row = Math.floor(i/cols);
    const x = pad + col*sw, y = pad + row*sh;
    ctx.fillStyle = p.hex; ctx.fillRect(x+12, y+12, sw-24, sh-80);
    ctx.fillStyle = '#fff'; ctx.fillText(p.name, x + sw/2, y + sh - 34);
  });
  ctx.fillStyle = '#fff'; ctx.font = '26px Inter, Arial'; ctx.fillText('Personal Fashion Palette', canvas.width/2, canvas.height - 20);
  const a = document.createElement('a'); a.download = 'fashion-palette.png'; a.href = canvas.toDataURL('image/png'); a.click();
});

/* upload another */
uploadAnotherBtn.addEventListener('click', () => {
  resultsCard.style.display = 'none';
  if (isSubscribed()) uploadCard.style.display = 'block';
  else subscribeCard.style.display = 'block';
  previewImage.src = ''; previewImage.style.display = 'none';
  fileInput.value = '';
  lastAnalysis = null;
  window._lastFashionPalette = null;
});

/* -------------------------
   Helpers for dynamic palette generation
   ------------------------- */
/* diversifyPalette already defined earlier */

/* -------------------------
   END
   ------------------------- */

</script>
</body>
</html>
